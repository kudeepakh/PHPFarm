services:
  # PHP Backend (Apache)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: phpfrarm_backend
    ports:
      - "${BACKEND_PORT:-8080}:80"
      - "9003:9003"
    volumes:
      - ./backend:/var/www/html
      - ./backend/logs:/var/www/html/logs
    environment:
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MONGO_HOST=mongodb
      - MONGO_PORT=27017
      - MONGO_ROOT_USER=${MONGO_ROOT_USER}
      - MONGO_ROOT_PASSWORD=${MONGO_ROOT_PASSWORD}
      - MONGO_DATABASE=${MONGO_DATABASE}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - APP_ENV=${APP_ENV:-development}
      - XDEBUG_MODE=${XDEBUG_MODE:-off}
      - XDEBUG_CLIENT_HOST=${XDEBUG_CLIENT_HOST:-host.docker.internal}
      - XDEBUG_CLIENT_PORT=${XDEBUG_CLIENT_PORT:-9003}
      - XDEBUG_START_WITH_REQUEST=${XDEBUG_START_WITH_REQUEST:-yes}
      - XDEBUG_CONFIG=client_host=${XDEBUG_CLIENT_HOST:-host.docker.internal} client_port=${XDEBUG_CLIENT_PORT:-9003}
      # Storage Configuration
      - STORAGE_DISK=${STORAGE_DISK:-minio}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY:-minioadmin}
      - MINIO_ENDPOINT=http://minio:9000
      - MINIO_BUCKET=${MINIO_BUCKET:-phpfrarm}
      - MINIO_USE_PATH_STYLE=true
      # Mail Configuration (Mailhog for local development)
      - MAIL_HOST=mailhog
      - MAIL_PORT=1025
      - MAIL_USERNAME=
      - MAIL_PASSWORD=
      - MAIL_ENCRYPTION=
      - MAIL_FROM_ADDRESS=${MAIL_FROM_ADDRESS:-noreply@phpfrarm.local}
      - MAIL_FROM_NAME=${MAIL_FROM_NAME:-PHPFrarm}
      # App URL for email links
      - APP_URL=${APP_URL:-http://localhost:8787}
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:3900}
    depends_on:
      mysql:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      redis:
        condition: service_started
      minio:
        condition: service_healthy
      mailhog:
        condition: service_started
    networks:
      - phpfrarm_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Queue Worker (background job processor)
  worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: phpfrarm_worker
    volumes:
      - ./backend:/var/www/html
      - ./backend/logs:/var/www/html/logs
    environment:
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MONGO_HOST=mongodb
      - MONGO_PORT=27017
      - MONGO_ROOT_USER=${MONGO_ROOT_USER}
      - MONGO_ROOT_PASSWORD=${MONGO_ROOT_PASSWORD}
      - MONGO_DATABASE=${MONGO_DATABASE}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - APP_ENV=${APP_ENV:-development}
      # Mail Configuration (Mailhog for local development)
      - MAIL_HOST=mailhog
      - MAIL_PORT=1025
      - MAIL_USERNAME=
      - MAIL_PASSWORD=
      - MAIL_ENCRYPTION=
      - MAIL_FROM_ADDRESS=${MAIL_FROM_ADDRESS:-noreply@phpfrarm.local}
      - MAIL_FROM_NAME=${MAIL_FROM_NAME:-PHPFrarm}
      # App URL for email links
      - APP_URL=${APP_URL:-http://localhost:8787}
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:3900}
    entrypoint: ["/bin/bash", "/var/www/html/worker-entrypoint.sh"]
    depends_on:
      mysql:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      redis:
        condition: service_started
      mailhog:
        condition: service_started
    networks:
      - phpfrarm_network
    restart: unless-stopped

  # MySQL Database
  mysql:
    image: mysql:8.0
    container_name: phpfrarm_mysql
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./backend/database/mysql/tables:/docker-entrypoint-initdb.d/01-tables
      - ./backend/database/mysql/stored_procedures:/docker-entrypoint-initdb.d/02-stored_procedures
    networks:
      - phpfrarm_network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # MongoDB
  mongodb:
    image: mongo:7.0
    container_name: phpfrarm_mongodb
    ports:
      - "${MONGO_PORT:-27017}:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_ROOT_USER}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_ROOT_PASSWORD}
      - MONGO_INITDB_DATABASE=${MONGO_DATABASE}
    volumes:
      - mongo_data:/data/db
      - ./backend/database/mongo/indexes:/docker-entrypoint-initdb.d
    networks:
      - phpfrarm_network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # Redis (Optional - for caching)
  redis:
    image: redis:7-alpine
    container_name: phpfrarm_redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    networks:
      - phpfrarm_network
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  # React Frontend (Vite + TypeScript)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: development
    container_name: phpfrarm_frontend
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    volumes:
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
      - ./frontend/index.html:/app/index.html
    environment:
      - VITE_API_URL=http://localhost:${BACKEND_PORT:-8080}
      - VITE_APP_ENV=${APP_ENV:-development}
    depends_on:
      - backend
    networks:
      - phpfrarm_network
    restart: unless-stopped

  # Nginx (Optional - API Gateway / Load Balancer)
  nginx:
    image: nginx:alpine
    container_name: phpfrarm_nginx
    ports:
      - "${NGINX_PORT:-80}:80"
      - "${NGINX_SSL_PORT:-443}:443"
    volumes:
      - ./infra/nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./infra/nginx/conf.d:/etc/nginx/conf.d
    depends_on:
      - backend
      - frontend
    networks:
      - phpfrarm_network
    restart: unless-stopped

  # MinIO - S3-Compatible Object Storage (Development)
  minio:
    image: minio/minio:latest
    container_name: phpfrarm_minio
    ports:
      - "${MINIO_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    volumes:
      - minio_data:/data
    environment:
      - MINIO_ROOT_USER=${MINIO_ACCESS_KEY:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_SECRET_KEY:-minioadmin}
    command: server /data --console-address ":9001"
    networks:
      - phpfrarm_network
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # MinIO Setup - Creates default bucket on startup
  minio-setup:
    image: minio/mc:latest
    container_name: phpfrarm_minio_setup
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 $${MINIO_ROOT_USER:-minioadmin} $${MINIO_ROOT_PASSWORD:-minioadmin};
      mc mb myminio/$${MINIO_DEFAULT_BUCKET:-phpfrarm} --ignore-existing;
      mc anonymous set download myminio/$${MINIO_DEFAULT_BUCKET:-phpfrarm}/public;
      exit 0;
      "
    environment:
      - MINIO_ROOT_USER=${MINIO_ACCESS_KEY:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_SECRET_KEY:-minioadmin}
      - MINIO_DEFAULT_BUCKET=${MINIO_BUCKET:-phpfrarm}
    networks:
      - phpfrarm_network

  # Mailhog - Local Email Testing Server
  mailhog:
    image: mailhog/mailhog:latest
    container_name: phpfrarm_mailhog
    ports:
      - "${MAILHOG_SMTP_PORT:-1025}:1025"      # SMTP port
      - "${MAILHOG_WEB_PORT:-8025}:8025"       # Web UI port
    networks:
      - phpfrarm_network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  mysql_data:
    driver: local
  mongo_data:
    driver: local
  redis_data:
    driver: local
  minio_data:
    driver: local

networks:
  phpfrarm_network:
    driver: bridge
