stages:
  - lint
  - security
  - test
  - build
  - deploy
  - verify

variables:
  PHP_VERSION: "8.2"
  NODE_VERSION: "20"
  MYSQL_VERSION: "8.0"
  REDIS_VERSION: "7"
  MONGODB_VERSION: "7"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""

# ==================== LINT STAGE ====================
lint:php:
  stage: lint
  image: php:${PHP_VERSION}-cli
  before_script:
    - apt-get update && apt-get install -y git zip unzip
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    - cd Farm/backend && composer install --prefer-dist --no-progress
  script:
    - composer run-script phpcs || true
    - composer run-script phpstan || true
  only:
    - merge_requests
    - main
    - develop
    - staging

lint:frontend:
  stage: lint
  image: node:${NODE_VERSION}-alpine
  before_script:
    - cd Farm/frontend && npm ci
  script:
    - npm run lint || true
  only:
    - merge_requests
    - main
    - develop

# ==================== SECURITY STAGE ====================
security:audit:
  stage: security
  image: php:${PHP_VERSION}-cli
  before_script:
    - cd Farm/backend && composer install --no-dev --prefer-dist
  script:
    - composer audit || true
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

security:dependency-check:
  stage: security
  image: owasp/dependency-check:latest
  script:
    - /usr/share/dependency-check/bin/dependency-check.sh --scan . --format HTML --project PHPFrarm
  artifacts:
    paths:
      - dependency-check-report.html
    expire_in: 7 days
  allow_failure: true
  only:
    - main
    - develop

# ==================== TEST STAGE ====================
test:unit:
  stage: test
  image: php:${PHP_VERSION}-cli
  services:
    - name: mysql:${MYSQL_VERSION}
      alias: mysql
    - name: redis:${REDIS_VERSION}-alpine
      alias: redis
    - name: mongo:${MONGODB_VERSION}
      alias: mongodb
  variables:
    MYSQL_ROOT_PASSWORD: root_password
    MYSQL_DATABASE: phpfrarm_test
    MONGO_INITDB_ROOT_USERNAME: root
    MONGO_INITDB_ROOT_PASSWORD: root_password
  before_script:
    - apt-get update && apt-get install -y git zip unzip libzip-dev libpq-dev
    - docker-php-ext-install pdo pdo_mysql zip
    - pecl install redis mongodb && docker-php-ext-enable redis mongodb
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    - cd Farm/backend && composer install --prefer-dist --no-progress
    - cp .env.testing .env
  script:
    - vendor/bin/phpunit --testsuite=Unit --coverage-text --coverage-cobertura=coverage.xml
  coverage: '/^\s*Lines:\s*\d+.\d+\%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: Farm/backend/coverage.xml
    expire_in: 7 days
  only:
    - merge_requests
    - main
    - develop

test:integration:
  stage: test
  image: php:${PHP_VERSION}-cli
  services:
    - name: mysql:${MYSQL_VERSION}
      alias: mysql
    - name: redis:${REDIS_VERSION}-alpine
      alias: redis
    - name: mongo:${MONGODB_VERSION}
      alias: mongodb
  variables:
    MYSQL_ROOT_PASSWORD: root_password
    MYSQL_DATABASE: phpfrarm_test
    MONGO_INITDB_ROOT_USERNAME: root
    MONGO_INITDB_ROOT_PASSWORD: root_password
  before_script:
    - apt-get update && apt-get install -y git zip unzip libzip-dev
    - docker-php-ext-install pdo pdo_mysql zip
    - pecl install redis mongodb && docker-php-ext-enable redis mongodb
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    - cd Farm/backend && composer install --prefer-dist --no-progress
    - cp .env.testing .env
  script:
    - vendor/bin/phpunit --testsuite=Integration
    - vendor/bin/phpunit --testsuite=API
  only:
    - merge_requests
    - main
    - develop

test:security:
  stage: test
  image: php:${PHP_VERSION}-cli
  before_script:
    - cd Farm/backend && composer install --prefer-dist
  script:
    - vendor/bin/phpunit --testsuite=Security
  only:
    - merge_requests
    - main
    - develop

test:contract:
  stage: test
  image: php:${PHP_VERSION}-cli
  before_script:
    - cd Farm/backend && composer install --prefer-dist
  script:
    - vendor/bin/phpunit --testsuite=Contract
  artifacts:
    when: on_failure
    paths:
      - Farm/backend/tests/contract-failures/
    expire_in: 3 days
  only:
    - merge_requests
    - main

# ==================== BUILD STAGE ====================
build:frontend:
  stage: build
  image: node:${NODE_VERSION}-alpine
  before_script:
    - cd Farm/frontend && npm ci
  script:
    - npm run build
  artifacts:
    paths:
      - Farm/frontend/build/
    expire_in: 7 days
  only:
    - main
    - develop
    - staging

build:docker:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA ./Farm/backend
    - docker build -t $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHORT_SHA ./Farm/frontend
    - docker push $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA
    - docker push $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHORT_SHA
    - |
      if [ "$CI_COMMIT_BRANCH" == "main" ]; then
        docker tag $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA $CI_REGISTRY_IMAGE/backend:latest
        docker tag $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHORT_SHA $CI_REGISTRY_IMAGE/frontend:latest
        docker push $CI_REGISTRY_IMAGE/backend:latest
        docker push $CI_REGISTRY_IMAGE/frontend:latest
      fi
  only:
    - main
    - develop
    - staging

# ==================== DEPLOY STAGE ====================
deploy:staging:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl bash
  script:
    - chmod +x ./infra/scripts/deploy.sh
    - ./infra/scripts/deploy.sh staging
  environment:
    name: staging
    url: https://staging.phpfrarm.com
  only:
    - develop

deploy:production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl bash
  script:
    - chmod +x ./infra/scripts/deploy.sh
    - ./infra/scripts/deploy.sh production
  environment:
    name: production
    url: https://api.phpfrarm.com
  when: manual
  only:
    - main

# ==================== VERIFY STAGE ====================
verify:health-check:
  stage: verify
  image: curlimages/curl:latest
  script:
    - sleep 30
    - curl -f $CI_ENVIRONMENT_URL/health || exit 1
    - curl -f $CI_ENVIRONMENT_URL/health/ready || exit 1
  only:
    - main
    - develop
  needs:
    - deploy:staging
    - deploy:production
  when: on_success

verify:smoke-tests:
  stage: verify
  image: curlimages/curl:latest
  script:
    - curl -f $CI_ENVIRONMENT_URL/api/status || exit 1
    - curl -f $CI_ENVIRONMENT_URL/docs || exit 1
  only:
    - main
    - develop
  needs:
    - deploy:staging
    - deploy:production
  when: on_success
